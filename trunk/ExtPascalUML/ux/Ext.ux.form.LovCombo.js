if('function'!==typeof RegExp.escape){RegExp.escape=function(s){if('string'!==typeof s){return s}return s.replace(/([.*+?^=!:${}()|[\]\/\\])/g,'\\$1')}}Ext.ns('Ext.ux.form');Ext.ux.form.LovCombo=Ext.extend(Ext.form.ComboBox,{checkField:'checked',separator:',',initComponent:function(){if(!this.tpl){this.tpl='<tpl for=".">'+'<div class="x-combo-list-item">'+'<img src="'+Ext.BLANK_IMAGE_URL+'" '+'class="ux-lovcombo-icon ux-lovcombo-icon-'+'{[values.'+this.checkField+'?"checked":"unchecked"'+']}">'+'<div class="ux-lovcombo-item-text">{'+(this.displayField||'text')+'}</div>'+'</div>'+'</tpl>'}Ext.ux.form.LovCombo.superclass.initComponent.apply(this,arguments);this.on({scope:this,beforequery:this.onBeforeQuery,blur:this.onRealBlur});this.onLoad=this.onLoad.createSequence(function(){if(this.el){var v=this.el.dom.value;this.el.dom.value='';this.el.dom.value=v}})},initEvents:function(){Ext.ux.form.LovCombo.superclass.initEvents.apply(this,arguments);this.keyNav.tab=false},clearValue:function(){this.value='';this.setRawValue(this.value);this.store.clearFilter();this.store.each(function(r){r.set(this.checkField,false)},this);if(this.hiddenField){this.hiddenField.value=''}this.applyEmptyText()},getCheckedDisplay:function(){var a=new RegExp(this.separator,"g");return this.getCheckedValue(this.displayField).replace(a,this.separator+' ')},getCheckedValue:function(a){a=a||this.valueField;var c=[];var b=this.store.snapshot||this.store.data;b.each(function(r){if(r.get(this.checkField)){c.push(r.get(a))}},this);return c.join(this.separator)},onBeforeQuery:function(a){a.query=a.query.replace(new RegExp(this.getCheckedDisplay()+'[ '+this.separator+']*'),'')},onRealBlur:function(){this.list.hide();var a=this.getRawValue();var b=a.split(new RegExp(RegExp.escape(this.separator)+' *'));var c=[];var d=this.store.snapshot||this.store.data;Ext.each(b,function(v){d.each(function(r){if(v===r.get(this.displayField)){c.push(r.get(this.valueField))}},this)},this);this.setValue(c.join(this.separator));this.store.clearFilter()},onSelect:function(a,b){if(this.fireEvent('beforeselect',this,a,b)!==false){a.set(this.checkField,!a.get(this.checkField));if(this.store.isFiltered()){this.doQuery(this.allQuery)}this.setValue(this.getCheckedValue());this.fireEvent('select',this,a,b)}},setValue:function(v){if(v){v=''+v;if(this.valueField){this.store.clearFilter();this.store.each(function(r){var a=!(!v.match('(^|'+this.separator+')'+RegExp.escape(r.get(this.valueField))+'('+this.separator+'|$)'));r.set(this.checkField,a)},this);this.value=this.getCheckedValue();this.setRawValue(this.getCheckedDisplay());if(this.hiddenField){this.hiddenField.value=this.value}}else{this.value=v;this.setRawValue(v);if(this.hiddenField){this.hiddenField.value=v}}if(this.el){this.el.removeClass(this.emptyClass)}}else{this.clearValue()}},selectAll:function(){this.store.each(function(a){a.set(this.checkField,true)},this);this.doQuery(this.allQuery);this.setValue(this.getCheckedValue())},deselectAll:function(){this.clearValue()}});Ext.reg('lovcombo',Ext.ux.form.LovCombo);